const dotenv = require('dotenv');
const { worker } = require('./worker/resender');
const { resenderQueue, addJob } = require('./queue');
const cron = require('node-cron');
const BotModel = require('./db/models/bot');
const mongoose = require('mongoose');

dotenv.config({ path: './config/config.env' });

process.setMaxListeners(0);

const producer = async () => {
  const conn = await mongoose.connect(process.env.MONGO_URI, {
    useUnifiedTopology: true,
    useNewUrlParser: true,
    useFindAndModify: false,
    useCreateIndex: true,
  });

  BotModel.find({}, (err, bots) => {
    bots.forEach(async ({ credentials, text }) => {
      await addJob(resenderQueue, { credentials, text });
    });
  });
};

worker.on('completed', (job) => console.log(`Completed job ${job.id} successfully finished, all messages resent`));
worker.on('failed', (job, err) => console.log(`Failed job ${job.id} with ${err}`));

console.log('Queue started at ', new Date());
cron.schedule('05 12 * * *', async () => {
  producer();
});

const acc = {
  credentials: {
    username: 'newlove_agency',
    password: 'Polki123',
  },
  text: [
    'ü•∞–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ —Å NewLove. –ü—Ä–∏–≤–µ—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞—é –¥–æ—Ö–æ–¥ –æ—Ç 700$-1200$. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é –Ω–∞ 7-12 —Å–∞–π—Ç–∞—Ö. –ï—Å–ª–∏ —Ç–≤–æ—è –∞–Ω–∫–µ—Ç–∞ –µ—Å—Ç—å –Ω–∞ —Å–∞–π—Ç–∞—Ö –±—Ä–∞—á–Ω—ã—Ö –∞–≥–µ–Ω—Ç—Å—Ç–≤- –º—ã –ø—Ä–µ–¥–ª–æ–∂–∏–º —Ç–µ–±–µ –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞. –° —É–≤–∞–∂–µ–Ω–∏–µ–º, –ö–∞—Ä–∏, –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞üòä',
    'ü•∞üòç–í–ù–ò–ú–ê–ù–ò–ï –ö–ê–°–¢–ò–ù–ìü§© –î–æ—Ö–æ–¥ –æ—Ç 2500$ –µ–∂–µ–º–µ—Å—è—á–Ω–æ –°—É—Ç—å: —Å–ø–µ—Ü—ã –∏–∑ –°–®–ê –≤–∫–ª–∞–¥—ã–≤–∞—é—Ç –¥–µ–Ω—å–≥–∏ –≤ —Ä–∞—Å–∫—Ä—É—Ç–∫—É –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ —Å –í–∞—à–∏–º–∏ —Ñ–æ—Ç–æ –≤ –∏–Ω—Å—Ç–µ (–æ—Ç 2500$ –¥–æ—Ö–æ–¥) –ª–∏–±–æ –æ–Ω–ª–∏—Ñ–∞–Ω—Å (–æ—Ç 4000$). –û—Ç –í–∞—Å —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—á–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–∏ 1-2 –¥–Ω–µ–π. –ü–ª—é—Å—ã: -–í—ã —Å–∞–º–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç, —á—Ç–æ –ø—Ä–∏–µ–º–ª–µ–º–æ, —á—Ç–æ –Ω–µ—Ç. - –°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ, —É—Ä–æ–≤–µ–Ω—å –∑–ø. –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –¥–µ–Ω—å–≥–∏ —Å –∏–Ω—Å—Ç–∞–≥—Ä–∞–º–º–∞ (—Å –æ–Ω–ª–∏—Ñ–∞–Ω—Å –≤—Å–µ –∏ —Ç–∞–∫ —è—Å–Ω–æ)? –ê–º–µ—Ä–∏–∫–∞–Ω—Ü—ã —Å –Ω—É–ª—è —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –∏–Ω—Å—Ç–µ —Å –≤–∞—à–∏–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏, –≤–∫–ª–∞–¥—ã–≤–∞—é—Ç –±–∞—à–µ–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –≤ –∞–Ω–∫–µ—Ç—É, –≤ —Ä–µ–∫–ª–∞–º—É, –∏ –ø–æ—Ç–æ–º –ø–æ –ø–æ–¥–æ–±–∏—é —Å –±—Ä–∞—á–Ω—ã–º–∏ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞–º–∏ —Ä–∞—Å–∫—Ä—É—á–∏–≤–≤—é—Ç –º—É–∂—á–∏–Ω –Ω–∞ –¥–µ–Ω—å–≥–∏ —Ç–æ–ª—å–∫–æ –≤ –∏–Ω—Å—Ç–µ.. –†–ê–°–ß–ò–¢–ê–ù–û –Ω–∞ –∞—É–¥–∏—Ç–æ—Ä–∏—é –°–®–ê. –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ? –¢–æ–≥–¥–∞ –ø—Ä–∏—à–ª—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∫–∞—Å—Ç–∏–Ω–≥–∞.',
  ],
};

addJob(resenderQueue, acc);